<!DOCTYPE html><html lang="zh-CN"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1"><meta name="format-detection" content="telephone=no"><meta name="apple-mobile-web-app-capable" content="yes"><meta name="apple-mobile-web-app-status-bar-style" content="black"><link rel="icon" href="https://xjc.cn-sh2.ufileos.com/assets/site/favicon-16x16.png?v=2.8.0" type="image/png" sizes="16x16"><link rel="icon" href="https://xjc.cn-sh2.ufileos.com/assets/site/favicon-32x32.png?v=2.8.0" type="image/png" sizes="32x32"><meta name="description" content="暨计网课设">
<meta property="og:type" content="article">
<meta property="og:title" content="歪脖斯考特初探">
<meta property="og:url" content="https://blog.2333332.xyz/2022/05/22/2022-05-22-a-guide-to-websocket/index.html">
<meta property="og:site_name" content="Krypton&#39;s Blog">
<meta property="og:description" content="暨计网课设">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://xjc.cn-sh2.ufileos.com/assets/blog/220522/banner.jpg">
<meta property="article:published_time" content="2022-05-22T23:09:08.000Z">
<meta property="article:modified_time" content="2022-05-22T23:09:08.000Z">
<meta property="article:author" content="Krypton">
<meta property="article:tag" content="python">
<meta property="article:tag" content="javascript">
<meta property="article:tag" content="websocket">
<meta property="article:tag" content="计算机网络">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://xjc.cn-sh2.ufileos.com/assets/blog/220522/banner.jpg"><title>歪脖斯考特初探 | Krypton's Blog</title><link ref="canonical" href="https://blog.2333332.xyz/2022/05/22/2022-05-22-a-guide-to-websocket/"><link rel="alternate" href="/atom.xml" type="application/atom+xml"><link rel="dns-prefetch" href="https://unpkg.2333332.xyz"><link rel="stylesheet" href="https://unpkg.2333332.xyz/@fortawesome/fontawesome-free@5.12.1/css/all.min.css" type="text/css"><link rel="stylesheet" href="/css/index.css?v=2.8.0"><link rel="stylesheet" href="/css/custom.css" type="text/css"><link rel="dns-prefetch" href="https://www.googletagmanager.com"><script src="https://www.googletagmanager.com/gtag/js?id=UA-132388937-1" async="" data-pjax=""></script><script data-pjax="">if (window.location.hostname !== 'localhost') {
  window.dataLayer = window.dataLayer || [];
  function gtag(){ dataLayer.push(arguments); }
  gtag('js', new Date());
  gtag('config', 'UA-132388937-1');
}</script><script>var Stun = window.Stun || {};
var CONFIG = {
  root: '/',
  algolia: undefined,
  assistSearch: undefined,
  fontIcon: {"prompt":{"success":"fas fa-check-circle","info":"fas fa-arrow-circle-right","warning":"fas fa-exclamation-circle","error":"fas fa-times-circle"},"copyBtn":"fas fa-copy"},
  sidebar: {"offsetTop":"20px","tocMaxDepth":6},
  header: {"enable":true,"showOnPost":false,"scrollDownIcon":false},
  postWidget: {"endText":true},
  nightMode: {"enable":true},
  back2top: {"enable":true},
  codeblock: {"style":"default","highlight":"light","wordWrap":false},
  reward: false,
  fancybox: false,
  zoomImage: {"gapAside":"20px"},
  galleryWaterfall: undefined,
  lazyload: true,
  pjax: {"avoidBanner":false},
  externalLink: {"icon":{"enable":true,"name":"fas fa-external-link-alt"}},
  shortcuts: undefined,
  prompt: {"copyButton":"复制","copySuccess":"复制成功","copyError":"复制失败"},
  sourcePath: {"js":"js","css":"css","images":"images"},
};

window.CONFIG = CONFIG;</script><meta name="generator" content="Hexo 6.0.0"></head><body><div class="container" id="container"><header class="header" id="header"><div class="header-inner header-inner--height header-inner--bgcolor"><nav class="header-nav header-nav--sticky"><div class="header-nav-inner"><div class="header-nav-menubtn"><i class="fas fa-bars"></i></div><div class="header-nav-menu"><div class="header-nav-menu-item"><a class="header-nav-menu-item__link" href="/"><span class="header-nav-menu-item__icon"><i class="fas fa-home"></i></span><span class="header-nav-menu-item__text">首页</span></a></div><div class="header-nav-menu-item"><a class="header-nav-menu-item__link" href="/archives/"><span class="header-nav-menu-item__icon"><i class="fas fa-folder-open"></i></span><span class="header-nav-menu-item__text">归档</span></a></div><div class="header-nav-menu-item"><a class="header-nav-menu-item__link" href="/categories/"><span class="header-nav-menu-item__icon"><i class="fas fa-layer-group"></i></span><span class="header-nav-menu-item__text">分类</span></a></div><div class="header-nav-menu-item"><a class="header-nav-menu-item__link" href="/tags/"><span class="header-nav-menu-item__icon"><i class="fas fa-tags"></i></span><span class="header-nav-menu-item__text">标签</span></a></div><div class="header-nav-menu-item"><a class="header-nav-menu-item__link" href="/about/"><span class="header-nav-menu-item__icon"><i class="fas fa-address-book"></i></span><span class="header-nav-menu-item__text">关于</span></a></div><div class="header-nav-menu-item"><a class="header-nav-menu-item__link" href="/friends/"><span class="header-nav-menu-item__icon"><i class="fas fa-user"></i></span><span class="header-nav-menu-item__text">友链</span></a></div></div><div class="header-nav-search"><span class="header-nav-search__icon"><i class="fas fa-search"></i></span><span class="header-nav-search__text">搜索</span></div><div class="header-nav-mode"><div class="mode"><div class="mode-track"><span class="mode-track-moon"></span><span class="mode-track-sun"></span></div><div class="mode-thumb"></div></div></div></div></nav></div></header><main class="main" id="main"><div class="main-inner"><div class="content-wrap" id="content-wrap"><div class="content" id="content"><!-- Just used to judge whether it is an article page--><div id="is-post"></div><div class="post"><header class="post-header"><h1 class="post-title">歪脖斯考特初探</h1><div class="post-meta"><span class="post-meta-item post-meta-item--createtime"><span class="post-meta-item__icon"><i class="far fa-calendar-plus"></i></span><span class="post-meta-item__info">发表于</span><span class="post-meta-item__value">2022-05-22</span></span><span class="post-meta-item post-meta-item--updatetime"><span class="post-meta-item__icon"><i class="far fa-calendar-check"></i></span><span class="post-meta-item__info">更新于</span><span class="post-meta-item__value">2022-05-22</span></span><span class="post-meta-item post-meta-item--wordcount"><span class="post-meta-item__icon"><i class="far fa-file-word"></i></span><span class="post-meta-item__info">字数统计</span><span class="post-meta-item__value">5k</span></span><span class="post-meta-item post-meta-item--visitors leancloud_visitors" id="/2022/05/22/2022-05-22-a-guide-to-websocket/" data-flag-title="歪脖斯考特初探"><span class="post-meta-item__icon"><i class="fas fa-eye"></i></span><span class="post-meta-item__info">阅读次数</span><span class="post-meta-item__value waline-pageview-count" data-path="/2022/05/22/2022-05-22-a-guide-to-websocket/"></span></span></div></header><div class="post-body"><div class="gallery"><img src="https://xjc.cn-sh2.ufileos.com/assets/blog/220522/banner.jpg"></div><p>banner：<span class="exturl"><a class="exturl__link"   target="_blank" rel="noopener" href="https://www.pixiv.net/artworks/98483067" >https://www.pixiv.net/artworks/98483067</a><span class="exturl__icon"><i class="fas fa-external-link-alt"></i></span></span></p>

        <h2 id="序-3"   >
          <a href="#序-3" class="heading-link"><i class="fas fa-link"></i></a>序</h2>
      
<p>转眼就快到期末周了，勤奋的群友都在偷偷卷这个事实使我这个真正摆烂的人有些焦虑。有的群友已经考完了好多门试，有的群友已经做完了好多门的课设，还有的群友已经获得了《<strong>We</strong> Were Here Forever》的好多成就和速通了好多gal，可以上显然和天天翘课的我没有一点关系，令人感叹。某天我像往常一样八点醒来时，（
        <img     class="lazyload lazyload-gif"
          src="/images/loading.svg" data-src="https://xjc.cn-sh2.ufileos.com/assets/blog/220522/8oclock.jpg?show=inline"  style="display: inline-block;"  alt="">
      发现老师早已在钉钉群里布置了个课设：</p>
<p>
        <img   class="lazyload lazyload-gif"
          src="/images/loading.svg" data-src="https://xjc.cn-sh2.ufileos.com/assets/blog/220522/choices.jpg"  alt="">
      </p>
<p>可一个都不会的选题让我犯了难。这时我又想起了万能的群友：</p>
<p>
        <img   class="lazyload lazyload-gif"
          src="/images/loading.svg" data-src="https://xjc.cn-sh2.ufileos.com/assets/blog/220522/ohisee.jpg"  alt="">
      </p>
<p>既然群友能在半夜花不到40分钟就从不会python到搞懂了用python写ws服务器，那本人也来斗胆试试罢。至於为什么标题是歪脖司考特，这当然也是因为上述的群友——AKA lot<sup class="footnote-ref"><a href="#fn1" id="fnref1">[1]</a></sup>大佬，亲口说它的读音是“WebScott”，并且认为此协议是server与物联网设备通信的极佳解决方案。虽然我对其读音和使用场景略有疑议，但专业的人做专业的事，还是顺从大佬好了。</p>
<p>既然是计网课设，那么最好研究一下稍微底层的东西。因此就不得不读一下像<strong>Farex的游戏库</strong>一样又臭又长的RFC了。A Request for Comments (RFC) is a publication in a series——维基百科是这么描述的。书上还特意提了一句RFC是“请求评论”<sup class="footnote-ref"><a href="#fn2" id="fnref2">[2]</a></sup>，感觉怪怪的。等我一看<span class="exturl"><a class="exturl__link"   target="_blank" rel="noopener" href="https://datatracker.ietf.org/doc/html/rfc6455" >RFC 6455</a><span class="exturl__icon"><i class="fas fa-external-link-alt"></i></span></span>才发现非常致命：rfc6455有足足70页，而大家熟知的FTP协议<sup class="footnote-ref"><a href="#fn3" id="fnref3">[3]</a></sup>只有68页，新一点的HTTP/2<sup class="footnote-ref"><a href="#fn4" id="fnref4">[4]</a></sup>也不过95页。这种时候我就不得不羡慕<strong>海圣六级680</strong>的含金量了。RFC 6455 目前處於 Proposed Standard 阶段，是建议标准。</p>
<p>看了一下上图表格的范例，发现大多数的固定选题都是利用python进行仿真。这可能比较简单，但并不好玩。仿真和实现还是有点区别的。同样的道理，随便找个包调用一下来实现<strong>我已经把规则都忘了的多人飞行棋</strong>看上去好像重点在前端，总觉得差点意思。本篇博文我们就试着来实现一下服务器端的websocket。</p>

        <h2 id="握手"   >
          <a href="#握手" class="heading-link"><i class="fas fa-link"></i></a>握手</h2>
      

        <h3 id="客户端"   >
          <a href="#客户端" class="heading-link"><i class="fas fa-link"></i></a>客户端</h3>
      
<blockquote>
<p>1.3.  Opening Handshake<br>
　　_This section is non-normative._<br>
　　The opening handshake is intended to be compatible with HTTP-based server-side software and intermediaries, so that a single port can be used by both HTTP clients talking to that server and WebSocket clients talking to that server.  To this end, the WebSocket client’s handshake is an HTTP Upgrade request:</p>
</blockquote>
<figure class="highlight plaintext"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">GET /chat HTTP/1.1</span><br><span class="line">Host: server.example.com</span><br><span class="line">Upgrade: websocket</span><br><span class="line">Connection: Upgrade</span><br><span class="line">Sec-WebSocket-Key: dGhlIHNhbXBsZSBub25jZQ==</span><br><span class="line">Origin: http://example.com</span><br><span class="line">Sec-WebSocket-Protocol: chat, superchat</span><br><span class="line">Sec-WebSocket-Version: 13</span><br></pre></td></tr></table></div></figure>
<p>我们可以看到客户端侧的握手请求与HTTP协议是兼容的，以便进行端口复用。</p>
<p>那么我们先搭建一个前端页面来进行测试<sup class="footnote-ref"><a href="#fn5" id="fnref5">[5]</a></sup>：</p>
<figure class="highlight html"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;!DOCTYPE <span class="keyword">html</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">html</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">head</span> <span class="attr">lang</span>=<span class="string">&quot;en&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">meta</span> <span class="attr">charset</span>=<span class="string">&quot;UTF-8&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">title</span>&gt;</span><span class="tag">&lt;/<span class="name">title</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">head</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">body</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">div</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">&quot;text&quot;</span> <span class="attr">id</span>=<span class="string">&quot;txt&quot;</span> /&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">&quot;button&quot;</span> <span class="attr">id</span>=<span class="string">&quot;btn&quot;</span> <span class="attr">value</span>=<span class="string">&quot;提交&quot;</span> <span class="attr">onclick</span>=<span class="string">&quot;sendMsg();&quot;</span> /&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">&quot;button&quot;</span> <span class="attr">id</span>=<span class="string">&quot;open&quot;</span> <span class="attr">value</span>=<span class="string">&quot;打开连接&quot;</span> <span class="attr">onclick</span>=<span class="string">&quot;openConn();&quot;</span> /&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">&quot;button&quot;</span> <span class="attr">id</span>=<span class="string">&quot;close&quot;</span> <span class="attr">value</span>=<span class="string">&quot;关闭连接&quot;</span> <span class="attr">onclick</span>=<span class="string">&quot;closeConn();&quot;</span> /&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">div</span> <span class="attr">id</span>=<span class="string">&quot;content&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">script</span> <span class="attr">type</span>=<span class="string">&quot;text/javascript&quot;</span>&gt;</span><span class="language-javascript"></span></span><br><span class="line"><span class="language-javascript">        <span class="keyword">var</span> socket;</span></span><br><span class="line"><span class="language-javascript">        <span class="keyword">function</span> <span class="title function_">openConn</span>(<span class="params"></span>) &#123;</span></span><br><span class="line"><span class="language-javascript">            socket = <span class="keyword">new</span> <span class="title class_">WebSocket</span>(<span class="string">&quot;ws://127.0.0.1:8003/chat&quot;</span>);</span></span><br><span class="line"><span class="language-javascript"></span></span><br><span class="line"><span class="language-javascript">            socket.<span class="property">onopen</span> = <span class="keyword">function</span> (<span class="params"></span>) &#123;</span></span><br><span class="line"><span class="language-javascript">                <span class="comment">/* 与服务器端连接成功后，自动执行 */</span></span></span><br><span class="line"><span class="language-javascript"></span></span><br><span class="line"><span class="language-javascript">                <span class="keyword">var</span> newTag = <span class="variable language_">document</span>.<span class="title function_">createElement</span>(<span class="string">&#x27;div&#x27;</span>);</span></span><br><span class="line"><span class="language-javascript">                newTag.<span class="property">innerHTML</span> = <span class="string">&quot;【连接成功】&quot;</span>;</span></span><br><span class="line"><span class="language-javascript">                <span class="variable language_">document</span>.<span class="title function_">getElementById</span>(<span class="string">&#x27;content&#x27;</span>).<span class="title function_">appendChild</span>(newTag);</span></span><br><span class="line"><span class="language-javascript">            &#125;;</span></span><br><span class="line"><span class="language-javascript"></span></span><br><span class="line"><span class="language-javascript">            socket.<span class="property">onmessage</span> = <span class="keyword">function</span> (<span class="params">event</span>) &#123;</span></span><br><span class="line"><span class="language-javascript">                <span class="comment">/* 服务器端向客户端发送数据时，自动执行 */</span></span></span><br><span class="line"><span class="language-javascript">                <span class="keyword">var</span> response = event.<span class="property">data</span>;</span></span><br><span class="line"><span class="language-javascript">                <span class="keyword">var</span> newTag = <span class="variable language_">document</span>.<span class="title function_">createElement</span>(<span class="string">&#x27;div&#x27;</span>);</span></span><br><span class="line"><span class="language-javascript">                newTag.<span class="property">innerHTML</span> = response;</span></span><br><span class="line"><span class="language-javascript">                <span class="variable language_">document</span>.<span class="title function_">getElementById</span>(<span class="string">&#x27;content&#x27;</span>).<span class="title function_">appendChild</span>(newTag);</span></span><br><span class="line"><span class="language-javascript">            &#125;;</span></span><br><span class="line"><span class="language-javascript"></span></span><br><span class="line"><span class="language-javascript">            socket.<span class="property">onclose</span> = <span class="keyword">function</span> (<span class="params">event</span>) &#123;</span></span><br><span class="line"><span class="language-javascript">                <span class="comment">/* 服务器端主动断开连接时，自动执行 */</span></span></span><br><span class="line"><span class="language-javascript">                socket = <span class="literal">undefined</span>;</span></span><br><span class="line"><span class="language-javascript">                <span class="keyword">var</span> newTag = <span class="variable language_">document</span>.<span class="title function_">createElement</span>(<span class="string">&#x27;div&#x27;</span>);</span></span><br><span class="line"><span class="language-javascript">                newTag.<span class="property">innerHTML</span> = <span class="string">&quot;【关闭连接，onclose回调】&quot;</span>;</span></span><br><span class="line"><span class="language-javascript">                <span class="variable language_">document</span>.<span class="title function_">getElementById</span>(<span class="string">&#x27;content&#x27;</span>).<span class="title function_">appendChild</span>(newTag);</span></span><br><span class="line"><span class="language-javascript">            &#125;;</span></span><br><span class="line"><span class="language-javascript">        &#125;</span></span><br><span class="line"><span class="language-javascript"></span></span><br><span class="line"><span class="language-javascript">        <span class="keyword">function</span> <span class="title function_">sendMsg</span>(<span class="params"></span>) &#123;</span></span><br><span class="line"><span class="language-javascript">            <span class="keyword">var</span> txt = <span class="variable language_">document</span>.<span class="title function_">getElementById</span>(<span class="string">&#x27;txt&#x27;</span>);</span></span><br><span class="line"><span class="language-javascript">            socket.<span class="title function_">send</span>(txt.<span class="property">value</span>);</span></span><br><span class="line"><span class="language-javascript">            txt.<span class="property">value</span> = <span class="string">&quot;&quot;</span>;</span></span><br><span class="line"><span class="language-javascript">        &#125;</span></span><br><span class="line"><span class="language-javascript"></span></span><br><span class="line"><span class="language-javascript">        <span class="keyword">function</span> <span class="title function_">closeConn</span>(<span class="params"></span>) &#123;</span></span><br><span class="line"><span class="language-javascript">            socket.<span class="title function_">close</span>();</span></span><br><span class="line"><span class="language-javascript">            <span class="keyword">var</span> newTag = <span class="variable language_">document</span>.<span class="title function_">createElement</span>(<span class="string">&#x27;div&#x27;</span>);</span></span><br><span class="line"><span class="language-javascript">            newTag.<span class="property">innerHTML</span> = <span class="string">&quot;【关闭连接】&quot;</span>;</span></span><br><span class="line"><span class="language-javascript">            <span class="variable language_">document</span>.<span class="title function_">getElementById</span>(<span class="string">&#x27;content&#x27;</span>).<span class="title function_">appendChild</span>(newTag);</span></span><br><span class="line"><span class="language-javascript">        &#125;</span></span><br><span class="line"><span class="language-javascript"></span></span><br><span class="line"><span class="language-javascript">    </span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></span><br></pre></td></tr></table></div></figure>
<p>后端想要实现，就离不开socket。书上又说了<sup class="footnote-ref"><a href="#fn6" id="fnref6">[6]</a></sup>，同一个名词socket可以表示多种不同的意思，这里既用到了TCP连接的端点，又用到了socket API。</p>
<figure class="highlight python"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">ADDRESS = (<span class="string">&#x27;127.0.0.1&#x27;</span>, <span class="number">8003</span>)</span><br><span class="line">BUFSIZE = <span class="number">4096</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">main</span>():</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 创建TCP Socket，AF_INET是一类地址族（address family），用于IPv4协议；SOCK_STREAM是一类Socket类型，提供面向流的TCP传输</span></span><br><span class="line">    sock = socket.socket(socket.AF_INET, socket.SOCK_STREAM)</span><br><span class="line"></span><br><span class="line">    sock.bind(ADDRESS)</span><br><span class="line">    sock.listen()</span><br><span class="line"></span><br><span class="line">    conn, address = sock.accept()  <span class="comment"># 阻塞方式等待连接</span></span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&#x27;connected by:&#x27;</span>, address)</span><br><span class="line">    data = <span class="string">b&#x27;&#x27;</span></span><br><span class="line">    <span class="keyword">while</span> <span class="literal">True</span>:</span><br><span class="line">        _ = conn.recv(BUFSIZE)</span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> _:</span><br><span class="line">            <span class="keyword">break</span></span><br><span class="line">        data += _</span><br><span class="line">    <span class="built_in">print</span>(data.decode())</span><br></pre></td></tr></table></div></figure>
<p>然后前端点击打开连接，浏览器就会自动发送一个握手请求，数据如下：</p>
<figure class="highlight plaintext"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">GET /chat HTTP/1.1</span><br><span class="line">Host: 127.0.0.1:8003</span><br><span class="line">Connection: Upgrade</span><br><span class="line">Pragma: no-cache</span><br><span class="line">Cache-Control: no-cache</span><br><span class="line">User-Agent: Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/101.0.4951.67 Safari/537.36</span><br><span class="line">Upgrade: websocket</span><br><span class="line">Origin: null</span><br><span class="line">Sec-WebSocket-Version: 13</span><br><span class="line">Accept-Encoding: gzip, deflate, br</span><br><span class="line">Accept-Language: zh-CN,zh;q=0.9,ja;q=0.8,en-US;q=0.7,en;q=0.6</span><br><span class="line">Sec-WebSocket-Key: f03NpU0iebD9rbIRGj8NPg==</span><br><span class="line">Sec-WebSocket-Extensions: permessage-deflate; client_max_window_bits</span><br></pre></td></tr></table></div></figure>
<p>可以看到，除了常规的请求头外，还有一些ws独有的：</p>
<ul>
<li>Connection: Upgrade # 设置 Connection 头的值为 “Upgrade” 来指示这是一个升级请求</li>
<li>Upgrade: websocket # Upgrade 头指定升级为ws协议</li>
<li>Sec-WebSocket-Key # base64后的随机数，后续server端需要用这个值来生成Sec-WebSocket-Accept</li>
<li>Sec-WebSocket-Protocol # 子协议，可选</li>
<li>Sec-WebSocket-Version # 必须为13</li>
<li>Sec-WebSocket-Extensions # 可选，指定客户端支持的扩展</li>
</ul>

        <h3 id="服务器端"   >
          <a href="#服务器端" class="heading-link"><i class="fas fa-link"></i></a>服务器端</h3>
      
<p>当服务器收到握手请求时，它应该发回一个特殊的响应，表明协议将从HTTP变为WebSocket。看起来像这样：</p>
<figure class="highlight plaintext"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">HTTP/1.1 101 Switching Protocols</span><br><span class="line">Upgrade: websocket</span><br><span class="line">Connection: Upgrade</span><br><span class="line">Sec-WebSocket-Accept: s3pPLMBiTxaQ9kYGzzhZRbK+xOo=</span><br></pre></td></tr></table></div></figure>
<p><code>Sec-WebSocket-Accept</code>怎样计算呢， 把客户发送的 Sec-WebSocket-Key 和 “258EAFA5-E914-47DA-95CA-C5AB0DC85B11” ( it’s a “magic string” )连接起来，把结果用SHA-1编码，再用base64编码一次，就可以了。</p>
<figure class="highlight python"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="title function_">get_sec_websocket_accept</span>(<span class="params">key</span>):</span><br><span class="line">    value = key + <span class="string">&#x27;258EAFA5-E914-47DA-95CA-C5AB0DC85B11&#x27;</span></span><br><span class="line">    ac = base64.b64encode(hashlib.sha1(value.encode(<span class="string">&#x27;utf-8&#x27;</span>)).digest())</span><br><span class="line">    <span class="keyword">return</span> ac.decode(<span class="string">&#x27;utf-8&#x27;</span>)</span><br></pre></td></tr></table></div></figure>
<p>那么我们就可以对握手请求进行响应了：</p>
<figure class="highlight python"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@classmethod</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">check_headers_and_return_ac</span>(<span class="params">cls, data: <span class="built_in">bytes</span></span>):</span><br><span class="line">    header_dict = &#123;&#125;</span><br><span class="line">    header = data.decode(<span class="string">&#x27;utf-8&#x27;</span>)</span><br><span class="line">    header_list = header.split(<span class="string">&#x27;\r\n&#x27;</span>)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">assert</span> header_list[<span class="number">0</span>] == <span class="string">&#x27;GET /chat HTTP/1.1&#x27;</span></span><br><span class="line">    <span class="keyword">for</span> line <span class="keyword">in</span> header_list[<span class="number">1</span>:]:</span><br><span class="line">        key, value = line.split(<span class="string">&#x27;: &#x27;</span>)</span><br><span class="line">        header_dict[key] = value</span><br><span class="line"></span><br><span class="line">    <span class="keyword">assert</span> header_dict[<span class="string">&#x27;Upgrade&#x27;</span>] == <span class="string">&#x27;websocket&#x27;</span></span><br><span class="line">    <span class="keyword">assert</span> header_dict[<span class="string">&#x27;Connection&#x27;</span>] == <span class="string">&#x27;Upgrade&#x27;</span></span><br><span class="line">    <span class="keyword">assert</span> header_dict[<span class="string">&#x27;Sec-WebSocket-Key&#x27;</span>]</span><br><span class="line">    <span class="keyword">assert</span> header_dict[<span class="string">&#x27;Sec-WebSocket-Version&#x27;</span>] == <span class="string">&#x27;13&#x27;</span></span><br><span class="line">    <span class="keyword">return</span> cls.get_sec_websocket_accept(header_dict[<span class="string">&#x27;Sec-WebSocket-Key&#x27;</span>])</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">accept_connection</span>(<span class="params">self</span>):</span><br><span class="line">    headers = <span class="string">b&#x27;&#x27;</span></span><br><span class="line">    <span class="keyword">while</span> <span class="literal">True</span>:</span><br><span class="line">        _ = self.conn.recv(<span class="number">1</span>)</span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> _:</span><br><span class="line">            <span class="keyword">raise</span> socket.error(socket.EBADF, <span class="string">&#x27;Bad file descriptor&#x27;</span>)</span><br><span class="line">        headers += _</span><br><span class="line">        <span class="keyword">if</span> headers.endswith(<span class="string">b&#x27;\r\n\r\n&#x27;</span>):</span><br><span class="line">            <span class="keyword">break</span></span><br><span class="line">    headers = headers[:-<span class="number">4</span>]</span><br><span class="line">    ac = self.check_headers_and_return_ac(headers)</span><br><span class="line">    ac_headers = <span class="string">&quot;HTTP/1.1 101 Switching Protocols\r\n&quot;</span> \</span><br><span class="line">        <span class="string">&quot;Upgrade:websocket\r\n&quot;</span> \</span><br><span class="line">        <span class="string">&quot;Connection:Upgrade\r\n&quot;</span> \</span><br><span class="line">        <span class="string">f&quot;Sec-WebSocket-Accept:<span class="subst">&#123;ac&#125;</span>\r\n\r\n&quot;</span></span><br><span class="line">    self.conn.sendall(ac_headers.encode(<span class="string">&quot;utf8&quot;</span>))</span><br></pre></td></tr></table></div></figure>
<p>至此，握手阶段结束。</p>

        <h2 id="数据帧"   >
          <a href="#数据帧" class="heading-link"><i class="fas fa-link"></i></a>数据帧</h2>
      
<p>结构如下图：</p>
<figure class="highlight plaintext"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">0                   1                   2                   3</span><br><span class="line">0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1</span><br><span class="line">+-+-+-+-+-------+-+-------------+-------------------------------+</span><br><span class="line">|F|R|R|R| opcode|M| Payload len |    Extended payload length    |</span><br><span class="line">|I|S|S|S|  (4)  |A|     (7)     |             (16/64)           |</span><br><span class="line">|N|V|V|V|       |S|             |   (if payload len==126/127)   |</span><br><span class="line">| |1|2|3|       |K|             |                               |</span><br><span class="line">+-+-+-+-+-------+-+-------------+ - - - - - - - - - - - - - - - +</span><br><span class="line">|     Extended payload length continued, if payload len == 127  |</span><br><span class="line">+ - - - - - - - - - - - - - - - +-------------------------------+</span><br><span class="line">|                               |Masking-key, if MASK set to 1  |</span><br><span class="line">+-------------------------------+-------------------------------+</span><br><span class="line">| Masking-key (continued)       |          Payload Data         |</span><br><span class="line">+-------------------------------- - - - - - - - - - - - - - - - +</span><br><span class="line">:                     Payload Data continued ...                :</span><br><span class="line">+ - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - +</span><br><span class="line">|                     Payload Data continued ...                |</span><br><span class="line">+---------------------------------------------------------------+</span><br></pre></td></tr></table></div></figure>

        <h3 id="读帧"   >
          <a href="#读帧" class="heading-link"><i class="fas fa-link"></i></a>读帧</h3>
      
<p>在处理数据时，我们先来考虑一个问题：如何从<code>socket</code>中读取长度为<code>bufsize</code>（字节）的数据？像我肯定直接来一个<code>socket.recv(bufsize)</code>，追求的就是一个简单粗暴。但我知道，像<strong>海圣和海南队长</strong>这种深耕量化交易浸心web3豪取NFT的大佬心思会更细腻些：</p>
<figure class="highlight python"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="title function_">_read_strict</span>(<span class="params">self, bufsize</span>):</span><br><span class="line">    remaining = bufsize</span><br><span class="line">    _<span class="built_in">bytes</span> = <span class="string">b&quot;&quot;</span></span><br><span class="line">    <span class="keyword">while</span> remaining:</span><br><span class="line">        _buffer = self.conn.recv(remaining)</span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> _buffer:</span><br><span class="line">            <span class="keyword">raise</span> socket.error(socket.EBADF, <span class="string">&#x27;Bad file descriptor&#x27;</span>)</span><br><span class="line">        _<span class="built_in">bytes</span> += _buffer</span><br><span class="line">        remaining = bufsize - <span class="built_in">len</span>(_<span class="built_in">bytes</span>)</span><br><span class="line">    <span class="keyword">return</span> _<span class="built_in">bytes</span></span><br></pre></td></tr></table></div></figure>
<p>上面的代码好处就比较多了——既防止了读取数据的长度比<code>bufsize</code>小（这是完全有可能的），也对套接字忽然的关闭抛出了异常。</p>
<p>接下来我们就可以根据RFC 5.2节来看一下Frame：</p>
<ol>
<li>
<p>FIN:  1 bit<br>
Indicates that this is the final fragment in a message. The first fragment MAY also be the final fragment.</p>
</li>
<li>
<p>RSV1, RSV2, RSV3:  1 bit each<br>
无扩展协商时，应始终为0。</p>
</li>
<li>
<p>Opcode:  4 bits<br>
操作代码，决定如何解析数据。如果操作代码未知，那么接收端应该断开连接。</p>
<ul>
<li>%x0：表示一个延续帧。当Opcode为0时，表示本次数据传输采用了数据分片，当前收到的数据帧为其中一个数据分片。</li>
<li>%x1：表示这是一个文本帧。</li>
<li>%x2：表示这是一个二进制帧。</li>
<li>%x3-7：保留的操作代码，用于后续定义的非控制帧。</li>
<li>%x8：表示连接断开。</li>
<li>%x9：表示这是一个ping操作。</li>
<li>%xA：表示这是一个pong操作。</li>
<li>%xB-F：保留的操作代码，用于后续定义的控制帧。</li>
</ul>
</li>
<li>
<p>Mask:  1 bit<br>
下文详述。</p>
</li>
<li>
<p>Payload length:  7 bits, 7+16 bits, or 7+64 bits<br>
The length of the “Payload data”.  以字节为单位。如果0-125，这是负载长度。如果126，之后的两字节解释为一个16位的无符号整数是负载长度。如果127，之后八字节解释为的一个64位的无符号整数是负载长度。字节排列方式为<code>(the most significant bit MUST be 0)</code>，既大端序。<br>
我在这补充一下我贫瘠的计算机基础以便理解，像<strong>网络工程大佬和土木计算机跨界大佬</strong>就不要嘲笑我了。7比特能表示的无符号整数的最大值是<code>2^7-1=127</code>，这种情况对应了上面<code>7+64 bits</code>。而1个<code>byte</code>（字节）的size是8个bit，所以上述也可以表示为<code>7 bits, 7 bits + 2 bytes, or 7 bits + 8 bytes</code>。值得注意的是，理论上一个帧的最大数据载荷是<code>(2^64-1)÷8÷1024÷1024÷1024=2147483648(GB)</code>，但实际上，过大的数据应该分片传输。</p>
</li>
<li>
<p>Masking-key:  0 or 4 bytes<br>
下文详述。</p>
</li>
<li>
<p>Payload data: Payload length<br>
Cuz <code>no extension has been negotiated</code>，<code>Payload data</code>的长度就是第五点的<code>Payload length</code>。</p>
</li>
</ol>
<p>然后就可以根据从字节流中获取各字段了，只要相应的位与1进行与即可：</p>
<figure class="highlight python"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">header_bytes = self._read_strict(<span class="number">2</span>)</span><br><span class="line">b1 = header_bytes[<span class="number">0</span>]</span><br><span class="line">fin = b1 &gt;&gt; <span class="number">7</span> &amp; <span class="number">1</span></span><br><span class="line">opcode = b1 &amp; <span class="number">0b1111</span></span><br><span class="line">b2 = header_bytes[<span class="number">1</span>]</span><br><span class="line">mask = b2 &gt;&gt; <span class="number">7</span> &amp; <span class="number">1</span></span><br><span class="line">length = b2 &amp; <span class="number">0b1111111</span></span><br><span class="line"></span><br><span class="line">length_data = <span class="string">&quot;&quot;</span></span><br><span class="line"><span class="keyword">if</span> length == <span class="number">126</span>:</span><br><span class="line">    length_data = self._read_strict(<span class="number">2</span>)</span><br><span class="line">    length = struct.unpack(<span class="string">&quot;!H&quot;</span>, length_data)[<span class="number">0</span>]</span><br><span class="line"><span class="keyword">elif</span> length == <span class="number">127</span>:</span><br><span class="line">    length_data = self._read_strict(<span class="number">8</span>)</span><br><span class="line">    length = struct.unpack(<span class="string">&quot;!Q&quot;</span>, length_data)[<span class="number">0</span>]</span><br></pre></td></tr></table></div></figure>
<blockquote>
<p>西南战争中西乡盛隆的战败标志着日本士族时代的结束，两军的的伤亡几乎相同。战争后，在被歌颂为“西国无双”的萨摩地区武士几乎绝迹，武士们同欧洲中世纪的骑士一样被历史的车轮无情地轧碎。线列兵与燧发枪将骑士们的冲锋击碎，国民军与野战炮将精于武道的武士沉寂。而讽刺的是，西乡盛隆本人在死后成为了日本军国派与统制派的精神图腾，追随西乡失败的旧武士们却掀起了一次次民权运动，极力维持着明治三杰逝去后崩坏的脆弱的民主制度。</p>
</blockquote>
<p><strong>举个比方，打个例子</strong>，经过我一个一个掰着手指头数了三遍，以上不知出处的文章共有203字，经utf8编码后有<code>203*3=609</code>个字节，所以<code>length=126</code>，length_data = <code>b'\x02a'</code>。用我们小学二年级就学过的进制相关知识，最终的length可以表示为<code>length_data[0] * (16^2) + length_data[1] = 609</code>。而如果一开始的<code>length==127</code>，这么硬算出来的length就是 <s><code>length_data[0] * (16^14) + length_data[1] * (16^12) + length_data[2] * (16^10) + length_data[3] * (16^8) + length_data[4] * (16^6) + length_data[5] * (16^4) + length_data[6] * (16^2) + length_data[7]</code></s> 。这显然略微有点麻烦，好在python的标准库struct<sup class="footnote-ref"><a href="#fn7" id="fnref7">[7]</a></sup>内建了unpack()可以很方便地来转换。</p>
<p>接下来看看<code>Mask</code>：所有从客户端发给服务端的数据都需要带有这个值。服务器接收时要用其来解码数据。算法如下：</p>
<figure class="highlight plaintext"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">Octet i of the transformed data (&quot;transformed-octet-i&quot;) is the XOR of </span><br><span class="line">octet i of the original data (&quot;original-octet-i&quot;) with octet at index</span><br><span class="line">i modulo 4 of the masking key (&quot;masking-key-octet-j&quot;):</span><br><span class="line">    j = i MOD 4</span><br><span class="line">transformed-octet-i = original-octet-i XOR masking-key-octet-j</span><br></pre></td></tr></table></div></figure>
<p>即</p>
<figure class="highlight python"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="title function_">unmask</span>(<span class="params">cls, mask: <span class="built_in">bytes</span>, data: <span class="built_in">bytes</span></span>):</span><br><span class="line">    mask = array.array(<span class="string">&quot;B&quot;</span>, mask)</span><br><span class="line">    original_data = array.array(<span class="string">&quot;B&quot;</span>, data)</span><br><span class="line">    transformed_data = array.array(<span class="string">&quot;B&quot;</span>, data)</span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="built_in">len</span>(data)):</span><br><span class="line">        transformed_data[i] = original_data[i] ^ mask[i % <span class="number">4</span>]</span><br><span class="line">    <span class="keyword">return</span> transformed_data.tobytes()</span><br></pre></td></tr></table></div></figure>
<p>总的代码：</p>
<figure class="highlight python"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="title function_">read_frame</span>(<span class="params">self</span>):</span><br><span class="line">    header_bytes = self._read_strict(<span class="number">2</span>)</span><br><span class="line">    b1 = header_bytes[<span class="number">0</span>]</span><br><span class="line">    fin = b1 &gt;&gt; <span class="number">7</span> &amp; <span class="number">1</span></span><br><span class="line">    opcode = b1 &amp; <span class="number">0b1111</span></span><br><span class="line">    b2 = header_bytes[<span class="number">1</span>]</span><br><span class="line">    mask = b2 &gt;&gt; <span class="number">7</span> &amp; <span class="number">1</span></span><br><span class="line">    length = b2 &amp; <span class="number">0b1111111</span></span><br><span class="line"></span><br><span class="line">    length_data = <span class="string">&quot;&quot;</span></span><br><span class="line">    <span class="keyword">if</span> length == <span class="number">126</span>:</span><br><span class="line">        length_data = self._read_strict(<span class="number">2</span>)</span><br><span class="line">        length = struct.unpack(<span class="string">&quot;!H&quot;</span>, length_data)[<span class="number">0</span>]</span><br><span class="line">    <span class="keyword">elif</span> length == <span class="number">0x7f</span>:</span><br><span class="line">        length_data = self._read_strict(<span class="number">8</span>)</span><br><span class="line">        length = struct.unpack(<span class="string">&quot;!Q&quot;</span>, length_data)[<span class="number">0</span>]</span><br><span class="line">    mask_key = <span class="string">&quot;&quot;</span></span><br><span class="line">    <span class="keyword">if</span> mask:</span><br><span class="line">        mask_key = self._read_strict(<span class="number">4</span>)</span><br><span class="line">    data = self._read_strict(length)</span><br><span class="line">    <span class="keyword">if</span> mask:</span><br><span class="line">        data = self.unmask(mask_key, data)</span><br><span class="line">    <span class="keyword">return</span> fin, opcode, data</span><br></pre></td></tr></table></div></figure>

        <h3 id="写帧"   >
          <a href="#写帧" class="heading-link"><i class="fas fa-link"></i></a>写帧</h3>
      
<p>过程与读帧类似。</p>
<figure class="highlight python"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="title function_">_write_frame</span>(<span class="params">self, fin: <span class="built_in">bool</span>, opcode: <span class="built_in">int</span>, data</span>):</span><br><span class="line">    <span class="keyword">if</span> fin:</span><br><span class="line">        finbit = <span class="number">0x80</span></span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        finbit = <span class="number">0</span></span><br><span class="line">    frame = struct.pack(<span class="string">&quot;!B&quot;</span>, finbit | opcode)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> <span class="built_in">isinstance</span>(data, <span class="built_in">str</span>):</span><br><span class="line">        data = data.encode(<span class="string">&#x27;utf-8&#x27;</span>)</span><br><span class="line"></span><br><span class="line">    length = <span class="built_in">len</span>(data)</span><br><span class="line">    <span class="keyword">if</span> length &lt; <span class="number">126</span>:</span><br><span class="line">        frame += struct.pack(<span class="string">&quot;!B&quot;</span>, length)</span><br><span class="line">    <span class="keyword">elif</span> length &lt;= <span class="number">0xFFFF</span>:</span><br><span class="line">        frame += struct.pack(<span class="string">&quot;!BH&quot;</span>, <span class="number">126</span>, length)</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        frame += struct.pack(<span class="string">&quot;!BQ&quot;</span>, <span class="number">127</span>, length)</span><br><span class="line"></span><br><span class="line">    frame += data</span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        self.conn.send(frame)</span><br><span class="line">    <span class="keyword">except</span> socket.error:</span><br><span class="line">        self.write_close()</span><br></pre></td></tr></table></div></figure>

        <h3 id="处理控制帧"   >
          <a href="#处理控制帧" class="heading-link"><i class="fas fa-link"></i></a>处理控制帧</h3>
      
<p>目前所定义的控制帧的opcode代码有0x8 (Close), 0x9 (Ping), and 0xA (Pong)。</p>

        <h4 id="关闭"   >
          <a href="#关闭" class="heading-link"><i class="fas fa-link"></i></a>关闭</h4>
      
<p>应用发送关闭帧后，不应继续发送数据帧。关闭帧可以有内容（body）。如果有内容，内容开头的两个字节是关闭状态码（status code）。如果终端首次收到关闭帧，则应尽快发送一个关闭帧。在都收到和发送关闭帧后，服务端认为ws连接已关闭，并且必须关闭TCP连接；客户端应等待服务端关闭连接。</p>
<figure class="highlight python"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="title function_">write_close</span>(<span class="params">self, code: <span class="built_in">int</span> = <span class="number">0</span>, reason: <span class="built_in">bytes</span> = <span class="string">b&#x27;&#x27;</span></span>):</span><br><span class="line">    <span class="keyword">if</span> code == <span class="number">0</span>:</span><br><span class="line">        code = <span class="number">1000</span>  <span class="comment"># rfc6455#section-7.4 &quot;normal closure&quot; status code</span></span><br><span class="line"></span><br><span class="line">    close_data = struct.pack(<span class="string">&#x27;&gt;H&#x27;</span>, code)</span><br><span class="line">    close_data += reason</span><br><span class="line">    self._write_frame(<span class="literal">True</span>, self.OPCODE_CLOSE, close_data)</span><br><span class="line">    self.connected = <span class="literal">False</span></span><br><span class="line">    self.conn.close()</span><br></pre></td></tr></table></div></figure>

        <h4 id="乒乓"   >
          <a href="#乒乓" class="heading-link"><i class="fas fa-link"></i></a>乒乓</h4>
      
<p>一句话，收到乒，就发送一个一样的乓。</p>

        <h2 id="总的代码"   >
          <a href="#总的代码" class="heading-link"><i class="fas fa-link"></i></a>总的代码</h2>
      

        <h3 id="后端"   >
          <a href="#后端" class="heading-link"><i class="fas fa-link"></i></a>后端</h3>
      
<figure class="highlight python"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> array</span><br><span class="line"><span class="keyword">import</span> base64</span><br><span class="line"><span class="keyword">import</span> hashlib</span><br><span class="line"><span class="keyword">import</span> socket</span><br><span class="line"><span class="keyword">import</span> struct</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">WebSocket</span>:</span><br><span class="line">    ADDRESS = (<span class="string">&#x27;127.0.0.1&#x27;</span>, <span class="number">8003</span>)</span><br><span class="line">    OPCODE_CONTINUATION = <span class="number">0x0</span></span><br><span class="line">    OPCODE_TEXT = <span class="number">0x1</span></span><br><span class="line">    OPCODE_BINARY = <span class="number">0x2</span></span><br><span class="line">    OPCODE_CLOSE = <span class="number">0x8</span></span><br><span class="line">    OPCODE_PING = <span class="number">0x9</span></span><br><span class="line">    OPCODE_PONG = <span class="number">0xa</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="comment"># 创建TCP Socket，AF_INET是一类地址族（address family），用于IPv4协议；SOCK_STREAM是一类Socket类型，提供面向流的TCP传输</span></span><br><span class="line">        self.sock = socket.socket(socket.AF_INET, socket.SOCK_STREAM)</span><br><span class="line"></span><br><span class="line">        self.sock.bind(self.ADDRESS)</span><br><span class="line">        self.sock.listen()</span><br><span class="line"></span><br><span class="line">        self.conn, self.address = self.sock.accept()  <span class="comment"># 阻塞方式等待连接</span></span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&#x27;connected by:&#x27;</span>, self.address)</span><br><span class="line"></span><br><span class="line">        self.connected = <span class="literal">False</span></span><br><span class="line">        self.run()</span><br><span class="line"></span><br><span class="line"><span class="meta">    @classmethod</span></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">get_sec_websocket_accept</span>(<span class="params">cls, key: <span class="built_in">str</span></span>):</span><br><span class="line">        value = key + <span class="string">&#x27;258EAFA5-E914-47DA-95CA-C5AB0DC85B11&#x27;</span></span><br><span class="line">        ac = base64.b64encode(hashlib.sha1(value.encode(<span class="string">&#x27;utf-8&#x27;</span>)).digest())</span><br><span class="line">        <span class="keyword">return</span> ac.decode(<span class="string">&#x27;utf-8&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="meta">    @classmethod</span></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">check_headers_and_return_ac</span>(<span class="params">cls, data: <span class="built_in">bytes</span></span>):</span><br><span class="line">        header_dict = &#123;&#125;</span><br><span class="line">        header = data.decode(<span class="string">&#x27;utf-8&#x27;</span>)</span><br><span class="line">        header_list = header.split(<span class="string">&#x27;\r\n&#x27;</span>)</span><br><span class="line"></span><br><span class="line">        <span class="keyword">assert</span> header_list[<span class="number">0</span>] == <span class="string">&#x27;GET /chat HTTP/1.1&#x27;</span></span><br><span class="line">        <span class="keyword">for</span> line <span class="keyword">in</span> header_list[<span class="number">1</span>:]:</span><br><span class="line">            key, value = line.split(<span class="string">&#x27;: &#x27;</span>)</span><br><span class="line">            header_dict[key] = value</span><br><span class="line"></span><br><span class="line">        <span class="keyword">assert</span> header_dict[<span class="string">&#x27;Upgrade&#x27;</span>] == <span class="string">&#x27;websocket&#x27;</span></span><br><span class="line">        <span class="keyword">assert</span> <span class="string">&#x27;Upgrade&#x27;</span> <span class="keyword">in</span> header_dict[<span class="string">&#x27;Connection&#x27;</span>]</span><br><span class="line">        <span class="keyword">assert</span> header_dict[<span class="string">&#x27;Sec-WebSocket-Key&#x27;</span>]</span><br><span class="line">        <span class="keyword">assert</span> header_dict[<span class="string">&#x27;Sec-WebSocket-Version&#x27;</span>] == <span class="string">&#x27;13&#x27;</span></span><br><span class="line">        <span class="keyword">return</span> cls.get_sec_websocket_accept(header_dict[<span class="string">&#x27;Sec-WebSocket-Key&#x27;</span>])</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">accept_connection</span>(<span class="params">self</span>):</span><br><span class="line">        headers = <span class="string">b&#x27;&#x27;</span></span><br><span class="line">        <span class="keyword">while</span> <span class="literal">True</span>:</span><br><span class="line">            _ = self.conn.recv(<span class="number">1</span>)</span><br><span class="line">            <span class="keyword">if</span> <span class="keyword">not</span> _:</span><br><span class="line">                <span class="keyword">raise</span> socket.error(socket.EBADF, <span class="string">&#x27;Bad file descriptor&#x27;</span>)</span><br><span class="line">            headers += _</span><br><span class="line">            <span class="keyword">if</span> headers.endswith(<span class="string">b&#x27;\r\n\r\n&#x27;</span>):</span><br><span class="line">                <span class="keyword">break</span></span><br><span class="line">        headers = headers[:-<span class="number">4</span>]</span><br><span class="line">        ac = self.check_headers_and_return_ac(headers)</span><br><span class="line">        ac_headers = <span class="string">&quot;HTTP/1.1 101 Switching Protocols\r\n&quot;</span> \</span><br><span class="line">            <span class="string">&quot;Upgrade:websocket\r\n&quot;</span> \</span><br><span class="line">            <span class="string">&quot;Connection:Upgrade\r\n&quot;</span> \</span><br><span class="line">            <span class="string">f&quot;Sec-WebSocket-Accept:<span class="subst">&#123;ac&#125;</span>\r\n\r\n&quot;</span></span><br><span class="line">        self.conn.sendall(ac_headers.encode(<span class="string">&quot;utf8&quot;</span>))</span><br><span class="line"></span><br><span class="line"><span class="meta">    @classmethod</span></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">unmask</span>(<span class="params">cls, mask: <span class="built_in">bytes</span>, data: <span class="built_in">bytes</span></span>):</span><br><span class="line">        mask = array.array(<span class="string">&quot;B&quot;</span>, mask)</span><br><span class="line">        original_data = array.array(<span class="string">&quot;B&quot;</span>, data)</span><br><span class="line">        transformed_data = array.array(<span class="string">&quot;B&quot;</span>, data)</span><br><span class="line">        <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="built_in">len</span>(data)):</span><br><span class="line">            transformed_data[i] = original_data[i] ^ mask[i % <span class="number">4</span>]</span><br><span class="line">        <span class="keyword">return</span> transformed_data.tobytes()</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">run</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> self.connected:</span><br><span class="line">            self.accept_connection()</span><br><span class="line">            self.connected = <span class="literal">True</span></span><br><span class="line">        <span class="keyword">while</span> self.connected:</span><br><span class="line">            opcode, data = self.read_data()</span><br><span class="line">            <span class="keyword">if</span> opcode == self.OPCODE_TEXT:</span><br><span class="line">                self._write_frame(<span class="literal">True</span>, self.OPCODE_TEXT, data)</span><br><span class="line">            <span class="keyword">elif</span> opcode == self.OPCODE_BINARY:</span><br><span class="line">                self._write_frame(<span class="literal">True</span>, self.OPCODE_BINARY, data)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">read_data</span>(<span class="params">self</span>):</span><br><span class="line">        fin, opcode, data = self.read_frame()</span><br><span class="line">        <span class="keyword">if</span> opcode == self.OPCODE_TEXT:</span><br><span class="line">            <span class="keyword">while</span> fin != <span class="number">1</span>:</span><br><span class="line">                fin, _, _data = self.read_frame()</span><br><span class="line">                data += _data</span><br><span class="line">            <span class="keyword">return</span> (opcode, data)</span><br><span class="line">        <span class="keyword">elif</span> opcode == self.OPCODE_BINARY:</span><br><span class="line">            <span class="keyword">return</span> (opcode, data)</span><br><span class="line">        <span class="keyword">elif</span> opcode == self.OPCODE_CLOSE:</span><br><span class="line">            close_code, close_reason = <span class="number">0</span>, <span class="string">b&#x27;&#x27;</span></span><br><span class="line">            <span class="keyword">if</span> <span class="built_in">len</span>(data) &gt;= <span class="number">2</span>:</span><br><span class="line">                close_code = struct.unpack(<span class="string">&#x27;&gt;H&#x27;</span>, data[:<span class="number">2</span>])[<span class="number">0</span>]</span><br><span class="line">            <span class="keyword">if</span> <span class="built_in">len</span>(data) &gt; <span class="number">2</span>:</span><br><span class="line">                close_reason = data[<span class="number">2</span>:]</span><br><span class="line">            self.write_close(close_code, close_reason)</span><br><span class="line">            <span class="keyword">return</span> (opcode, <span class="literal">None</span>)</span><br><span class="line">        <span class="keyword">elif</span> opcode == self.OPCODE_PING:</span><br><span class="line">            self._write_frame(<span class="literal">True</span>, self.OPCODE_PONG, data)</span><br><span class="line">            <span class="keyword">return</span> (opcode, data)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">read_frame</span>(<span class="params">self</span>):</span><br><span class="line">        header_bytes = self._read_strict(<span class="number">2</span>)</span><br><span class="line">        b1 = header_bytes[<span class="number">0</span>]</span><br><span class="line">        fin = b1 &gt;&gt; <span class="number">7</span> &amp; <span class="number">1</span></span><br><span class="line">        opcode = b1 &amp; <span class="number">0b1111</span></span><br><span class="line">        b2 = header_bytes[<span class="number">1</span>]</span><br><span class="line">        mask = b2 &gt;&gt; <span class="number">7</span> &amp; <span class="number">1</span></span><br><span class="line">        length = b2 &amp; <span class="number">0b1111111</span></span><br><span class="line"></span><br><span class="line">        length_data = <span class="string">&quot;&quot;</span></span><br><span class="line">        <span class="keyword">if</span> length == <span class="number">126</span>:</span><br><span class="line">            length_data = self._read_strict(<span class="number">2</span>)</span><br><span class="line">            length = struct.unpack(<span class="string">&quot;!H&quot;</span>, length_data)[<span class="number">0</span>]</span><br><span class="line">        <span class="keyword">elif</span> length == <span class="number">0x7f</span>:</span><br><span class="line">            length_data = self._read_strict(<span class="number">8</span>)</span><br><span class="line">            length = struct.unpack(<span class="string">&quot;!Q&quot;</span>, length_data)[<span class="number">0</span>]</span><br><span class="line">        mask_key = <span class="string">&quot;&quot;</span></span><br><span class="line">        <span class="keyword">if</span> mask:</span><br><span class="line">            mask_key = self._read_strict(<span class="number">4</span>)</span><br><span class="line">        data = self._read_strict(length)</span><br><span class="line">        <span class="keyword">if</span> mask:</span><br><span class="line">            data = self.unmask(mask_key, data)</span><br><span class="line">        <span class="keyword">return</span> fin, opcode, data</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">_write_frame</span>(<span class="params">self, fin: <span class="built_in">bool</span>, opcode: <span class="built_in">int</span>, data</span>):</span><br><span class="line">        <span class="keyword">if</span> fin:</span><br><span class="line">            finbit = <span class="number">0x80</span></span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            finbit = <span class="number">0</span></span><br><span class="line">        frame = struct.pack(<span class="string">&quot;!B&quot;</span>, finbit | opcode)</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> <span class="built_in">isinstance</span>(data, <span class="built_in">str</span>):</span><br><span class="line">            data = data.encode(<span class="string">&#x27;utf-8&#x27;</span>)</span><br><span class="line"></span><br><span class="line">        length = <span class="built_in">len</span>(data)</span><br><span class="line">        <span class="keyword">if</span> length &lt; <span class="number">126</span>:</span><br><span class="line">            frame += struct.pack(<span class="string">&quot;!B&quot;</span>, length)</span><br><span class="line">        <span class="keyword">elif</span> length &lt;= <span class="number">0xFFFF</span>:</span><br><span class="line">            frame += struct.pack(<span class="string">&quot;!BH&quot;</span>, <span class="number">126</span>, length)</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            frame += struct.pack(<span class="string">&quot;!BQ&quot;</span>, <span class="number">127</span>, length)</span><br><span class="line"></span><br><span class="line">        frame += data</span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            self.conn.send(frame)</span><br><span class="line">        <span class="keyword">except</span> socket.error:</span><br><span class="line">            self.write_close()</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">write_close</span>(<span class="params">self, code: <span class="built_in">int</span> = <span class="number">0</span>, reason: <span class="built_in">bytes</span> = <span class="string">b&#x27;&#x27;</span></span>):</span><br><span class="line">        <span class="keyword">if</span> code == <span class="number">0</span>:</span><br><span class="line">            code = <span class="number">1000</span>  <span class="comment"># rfc6455#section-7.4 &quot;normal closure&quot; status code</span></span><br><span class="line"></span><br><span class="line">        close_data = struct.pack(<span class="string">&#x27;&gt;H&#x27;</span>, code)</span><br><span class="line">        close_data += reason</span><br><span class="line">        self._write_frame(<span class="literal">True</span>, self.OPCODE_CLOSE, close_data)</span><br><span class="line">        self.connected = <span class="literal">False</span></span><br><span class="line">        self.conn.close()</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">_read_strict</span>(<span class="params">self, bufsize</span>):</span><br><span class="line">        remaining = bufsize</span><br><span class="line">        _<span class="built_in">bytes</span> = <span class="string">b&quot;&quot;</span></span><br><span class="line">        <span class="keyword">while</span> remaining:</span><br><span class="line">            _buffer = self.conn.recv(remaining)</span><br><span class="line">            <span class="keyword">if</span> <span class="keyword">not</span> _buffer:</span><br><span class="line">                <span class="keyword">raise</span> socket.error(socket.EBADF, <span class="string">&#x27;Bad file descriptor&#x27;</span>)</span><br><span class="line">            _<span class="built_in">bytes</span> += _buffer</span><br><span class="line">            remaining = bufsize - <span class="built_in">len</span>(_<span class="built_in">bytes</span>)</span><br><span class="line">        <span class="keyword">return</span> _<span class="built_in">bytes</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">    ws = WebSocket()</span><br></pre></td></tr></table></div></figure>

        <h3 id="前端"   >
          <a href="#前端" class="heading-link"><i class="fas fa-link"></i></a>前端</h3>
      
<figure class="highlight html"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;!DOCTYPE <span class="keyword">html</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">html</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">head</span> <span class="attr">lang</span>=<span class="string">&quot;zh&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">meta</span> <span class="attr">charset</span>=<span class="string">&quot;UTF-8&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">title</span>&gt;</span><span class="tag">&lt;/<span class="name">title</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">head</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">body</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">div</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">&quot;text&quot;</span> <span class="attr">id</span>=<span class="string">&quot;txt&quot;</span> /&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">&quot;button&quot;</span> <span class="attr">id</span>=<span class="string">&quot;btn&quot;</span> <span class="attr">value</span>=<span class="string">&quot;提交&quot;</span> <span class="attr">onclick</span>=<span class="string">&quot;sendMsg()&quot;</span> /&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">&quot;button&quot;</span> <span class="attr">id</span>=<span class="string">&quot;open&quot;</span> <span class="attr">value</span>=<span class="string">&quot;打开连接&quot;</span> <span class="attr">onclick</span>=<span class="string">&quot;openConn()&quot;</span> /&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">&quot;button&quot;</span> <span class="attr">id</span>=<span class="string">&quot;close&quot;</span> <span class="attr">value</span>=<span class="string">&quot;关闭连接&quot;</span> <span class="attr">onclick</span>=<span class="string">&quot;closeConn()&quot;</span> /&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">&quot;button&quot;</span> <span class="attr">id</span>=<span class="string">&quot;start_record&quot;</span> <span class="attr">value</span>=<span class="string">&quot;开始录音&quot;</span> <span class="attr">onclick</span>=<span class="string">&quot;start_record()&quot;</span> /&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">audio</span>&gt;</span><span class="tag">&lt;/<span class="name">audio</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">div</span> <span class="attr">id</span>=<span class="string">&quot;content&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">script</span> <span class="attr">type</span>=<span class="string">&quot;text/javascript&quot;</span>&gt;</span><span class="language-javascript"></span></span><br><span class="line"><span class="language-javascript">        <span class="keyword">let</span> socket, stream, recorder;</span></span><br><span class="line"><span class="language-javascript">        <span class="keyword">var</span> sourceBuffer;</span></span><br><span class="line"><span class="language-javascript">        <span class="keyword">var</span> mediaSource = <span class="keyword">new</span> <span class="title class_">MediaSource</span>();</span></span><br><span class="line"><span class="language-javascript">        <span class="keyword">var</span> audio = <span class="variable language_">document</span>.<span class="title function_">querySelector</span>(<span class="string">&#x27;audio&#x27;</span>);</span></span><br><span class="line"><span class="language-javascript">        audio.<span class="property">controls</span> = <span class="literal">true</span>;</span></span><br><span class="line"><span class="language-javascript">        audio.<span class="property">src</span> = <span class="variable constant_">URL</span>.<span class="title function_">createObjectURL</span>(mediaSource);</span></span><br><span class="line"><span class="language-javascript">        mediaSource.<span class="title function_">addEventListener</span>(<span class="string">&#x27;sourceopen&#x27;</span>, sourceOpen);</span></span><br><span class="line"><span class="language-javascript"></span></span><br><span class="line"><span class="language-javascript">        <span class="keyword">const</span> <span class="title function_">now</span> = (<span class="params"></span>) =&gt; &#123;</span></span><br><span class="line"><span class="language-javascript">            <span class="keyword">const</span> date = <span class="keyword">new</span> <span class="title class_">Date</span>();</span></span><br><span class="line"><span class="language-javascript">            <span class="keyword">return</span> <span class="string">`<span class="subst">$&#123;date.getHours()&#125;</span>:<span class="subst">$&#123;date.getMinutes()&#125;</span>:<span class="subst">$&#123;date.getSeconds()&#125;</span>:<span class="subst">$&#123;date.getMilliseconds()&#125;</span>`</span>;</span></span><br><span class="line"><span class="language-javascript">        &#125;</span></span><br><span class="line"><span class="language-javascript"></span></span><br><span class="line"><span class="language-javascript">        <span class="keyword">function</span> <span class="title function_">sourceOpen</span>(<span class="params">e</span>) &#123;</span></span><br><span class="line"><span class="language-javascript">            sourceBuffer = mediaSource.<span class="title function_">addSourceBuffer</span>(<span class="string">&#x27;audio/webm; codecs=opus&#x27;</span>);</span></span><br><span class="line"><span class="language-javascript">        &#125;</span></span><br><span class="line"><span class="language-javascript"></span></span><br><span class="line"><span class="language-javascript">        <span class="keyword">const</span> <span class="title function_">openConn</span> = (<span class="params"></span>) =&gt; &#123;</span></span><br><span class="line"><span class="language-javascript">            socket = <span class="keyword">new</span> <span class="title class_">WebSocket</span>(<span class="string">&quot;ws://127.0.0.1:8003/chat&quot;</span>);</span></span><br><span class="line"><span class="language-javascript"></span></span><br><span class="line"><span class="language-javascript">            socket.<span class="property">onopen</span> = <span class="keyword">function</span> (<span class="params"></span>) &#123;</span></span><br><span class="line"><span class="language-javascript">                <span class="comment">/* 与服务器端连接成功后，自动执行 */</span></span></span><br><span class="line"><span class="language-javascript">                audio.<span class="title function_">play</span>();</span></span><br><span class="line"><span class="language-javascript">                <span class="keyword">const</span> newTag = <span class="variable language_">document</span>.<span class="title function_">createElement</span>(<span class="string">&#x27;div&#x27;</span>);</span></span><br><span class="line"><span class="language-javascript">                newTag.<span class="property">innerHTML</span> = <span class="string">&quot;【连接成功】&quot;</span>;</span></span><br><span class="line"><span class="language-javascript">                <span class="variable language_">document</span>.<span class="title function_">getElementById</span>(<span class="string">&#x27;content&#x27;</span>).<span class="title function_">appendChild</span>(newTag);</span></span><br><span class="line"><span class="language-javascript">            &#125;;</span></span><br><span class="line"><span class="language-javascript"></span></span><br><span class="line"><span class="language-javascript">            socket.<span class="property">onmessage</span> = <span class="keyword">async</span> (event) =&gt; &#123;</span></span><br><span class="line"><span class="language-javascript">                <span class="comment">/* 服务器端向客户端发送数据时，自动执行 */</span></span></span><br><span class="line"><span class="language-javascript">                <span class="keyword">if</span> (<span class="keyword">typeof</span> event.<span class="property">data</span> === <span class="string">&#x27;string&#x27;</span>) &#123;</span></span><br><span class="line"><span class="language-javascript">                    <span class="keyword">const</span> response = <span class="string">`收到文本： <span class="subst">$&#123;event.data&#125;</span> <span class="subst">$&#123;now()&#125;</span> `</span>;</span></span><br><span class="line"><span class="language-javascript">                    <span class="keyword">const</span> newTag = <span class="variable language_">document</span>.<span class="title function_">createElement</span>(<span class="string">&#x27;div&#x27;</span>);</span></span><br><span class="line"><span class="language-javascript">                    newTag.<span class="property">innerHTML</span> = response;</span></span><br><span class="line"><span class="language-javascript">                    <span class="variable language_">document</span>.<span class="title function_">getElementById</span>(<span class="string">&#x27;content&#x27;</span>).<span class="title function_">appendChild</span>(newTag);</span></span><br><span class="line"><span class="language-javascript">                &#125; <span class="keyword">else</span> &#123;</span></span><br><span class="line"><span class="language-javascript">                    <span class="keyword">const</span> _buffer = <span class="keyword">await</span> event.<span class="property">data</span>.<span class="title function_">arrayBuffer</span>()</span></span><br><span class="line"><span class="language-javascript">                    sourceBuffer.<span class="title function_">appendBuffer</span>(_buffer);</span></span><br><span class="line"><span class="language-javascript">                &#125;</span></span><br><span class="line"><span class="language-javascript">            &#125;;</span></span><br><span class="line"><span class="language-javascript"></span></span><br><span class="line"><span class="language-javascript">            socket.<span class="property">onclose</span> = <span class="keyword">function</span> (<span class="params">event</span>) &#123;</span></span><br><span class="line"><span class="language-javascript">                <span class="comment">/* 服务器端主动断开连接时，自动执行 */</span></span></span><br><span class="line"><span class="language-javascript">                socket = <span class="literal">undefined</span>;</span></span><br><span class="line"><span class="language-javascript">                <span class="keyword">const</span> newTag = <span class="variable language_">document</span>.<span class="title function_">createElement</span>(<span class="string">&#x27;div&#x27;</span>);</span></span><br><span class="line"><span class="language-javascript">                newTag.<span class="property">innerHTML</span> = <span class="string">&quot;【关闭连接，onclose回调】&quot;</span>;</span></span><br><span class="line"><span class="language-javascript">                <span class="variable language_">document</span>.<span class="title function_">getElementById</span>(<span class="string">&#x27;content&#x27;</span>).<span class="title function_">appendChild</span>(newTag);</span></span><br><span class="line"><span class="language-javascript">            &#125;;</span></span><br><span class="line"><span class="language-javascript">        &#125;</span></span><br><span class="line"><span class="language-javascript"></span></span><br><span class="line"><span class="language-javascript">        <span class="keyword">const</span> <span class="title function_">sendMsg</span> = (<span class="params"></span>) =&gt; &#123;</span></span><br><span class="line"><span class="language-javascript">            <span class="keyword">const</span> txt = <span class="variable language_">document</span>.<span class="title function_">getElementById</span>(<span class="string">&#x27;txt&#x27;</span>);</span></span><br><span class="line"><span class="language-javascript">            socket.<span class="title function_">send</span>(txt.<span class="property">value</span>);</span></span><br><span class="line"><span class="language-javascript">            <span class="keyword">const</span> msg = <span class="string">`发送文本： <span class="subst">$&#123;txt.value&#125;</span> <span class="subst">$&#123;now()&#125;</span> `</span>;</span></span><br><span class="line"><span class="language-javascript">            <span class="keyword">const</span> newTag = <span class="variable language_">document</span>.<span class="title function_">createElement</span>(<span class="string">&#x27;div&#x27;</span>);</span></span><br><span class="line"><span class="language-javascript">            newTag.<span class="property">innerHTML</span> = msg;</span></span><br><span class="line"><span class="language-javascript">            <span class="variable language_">document</span>.<span class="title function_">getElementById</span>(<span class="string">&#x27;content&#x27;</span>).<span class="title function_">appendChild</span>(newTag);</span></span><br><span class="line"><span class="language-javascript">            txt.<span class="property">value</span> = <span class="string">&quot;&quot;</span>;</span></span><br><span class="line"><span class="language-javascript">        &#125;</span></span><br><span class="line"><span class="language-javascript"></span></span><br><span class="line"><span class="language-javascript">        <span class="keyword">const</span> <span class="title function_">closeConn</span> = (<span class="params"></span>) =&gt; &#123;</span></span><br><span class="line"><span class="language-javascript">            socket.<span class="title function_">close</span>();</span></span><br><span class="line"><span class="language-javascript">            <span class="keyword">if</span> (recorder &amp;&amp; recorder.<span class="property">state</span> !== <span class="string">&#x27;inactive&#x27;</span>) &#123;</span></span><br><span class="line"><span class="language-javascript">                recorder.<span class="title function_">stop</span>();</span></span><br><span class="line"><span class="language-javascript">            &#125;</span></span><br><span class="line"><span class="language-javascript">            <span class="keyword">const</span> newTag = <span class="variable language_">document</span>.<span class="title function_">createElement</span>(<span class="string">&#x27;div&#x27;</span>);</span></span><br><span class="line"><span class="language-javascript">            newTag.<span class="property">innerHTML</span> = <span class="string">&quot;【主动关闭连接】&quot;</span>;</span></span><br><span class="line"><span class="language-javascript">            <span class="variable language_">document</span>.<span class="title function_">getElementById</span>(<span class="string">&#x27;content&#x27;</span>).<span class="title function_">appendChild</span>(newTag);</span></span><br><span class="line"><span class="language-javascript">        &#125;</span></span><br><span class="line"><span class="language-javascript"></span></span><br><span class="line"><span class="language-javascript">        <span class="keyword">const</span> <span class="title function_">start_record</span> = <span class="keyword">async</span> (<span class="params"></span>) =&gt; &#123;</span></span><br><span class="line"><span class="language-javascript">            stream = <span class="keyword">await</span> navigator.<span class="property">mediaDevices</span>.<span class="title function_">getUserMedia</span>(&#123; <span class="attr">audio</span>: <span class="literal">true</span> &#125;);</span></span><br><span class="line"><span class="language-javascript">            recorder = <span class="keyword">new</span> <span class="title class_">MediaRecorder</span>(stream);</span></span><br><span class="line"><span class="language-javascript">            recorder.<span class="property">ondataavailable</span> = <span class="keyword">async</span> (e) =&gt; &#123;</span></span><br><span class="line"><span class="language-javascript">                <span class="keyword">if</span> (<span class="keyword">typeof</span> socket === <span class="string">&#x27;undefined&#x27;</span>) &#123;</span></span><br><span class="line"><span class="language-javascript">                    <span class="keyword">return</span>;</span></span><br><span class="line"><span class="language-javascript">                &#125;</span></span><br><span class="line"><span class="language-javascript">                <span class="comment">// 理论上可以直接用`socket.send(e.data)`，</span></span></span><br><span class="line"><span class="language-javascript">                <span class="comment">// 但是谷歌浏览器实现有bug，详见https://bugs.chromium.org/p/chromium/issues/detail?id=962857</span></span></span><br><span class="line"><span class="language-javascript">                <span class="keyword">const</span> filereader = <span class="keyword">new</span> <span class="title class_">FileReader</span>();</span></span><br><span class="line"><span class="language-javascript">                filereader.<span class="property">onload</span> = <span class="function">() =&gt;</span> &#123;</span></span><br><span class="line"><span class="language-javascript">                    socket.<span class="title function_">send</span>(filereader.<span class="property">result</span>)</span></span><br><span class="line"><span class="language-javascript">                &#125;;</span></span><br><span class="line"><span class="language-javascript">                filereader.<span class="title function_">readAsArrayBuffer</span>(e.<span class="property">data</span>);</span></span><br><span class="line"><span class="language-javascript">            &#125;</span></span><br><span class="line"><span class="language-javascript"></span></span><br><span class="line"><span class="language-javascript">            recorder.<span class="title function_">start</span>(<span class="number">100</span>);</span></span><br><span class="line"><span class="language-javascript">            <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;started&#x27;</span>);</span></span><br><span class="line"><span class="language-javascript"></span></span><br><span class="line"><span class="language-javascript">        &#125;</span></span><br><span class="line"><span class="language-javascript"></span></span><br><span class="line"><span class="language-javascript">        <span class="keyword">const</span> <span class="title function_">stop_record</span> = (<span class="params"></span>) =&gt; &#123;</span></span><br><span class="line"><span class="language-javascript">            recorder.<span class="title function_">stop</span>();</span></span><br><span class="line"><span class="language-javascript">        &#125;</span></span><br><span class="line"><span class="language-javascript"></span></span><br><span class="line"><span class="language-javascript">    </span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></span><br></pre></td></tr></table></div></figure>
<hr class="footnotes-sep">
<section class="footnotes">
<ol class="footnotes-list">
<li id="fn1" class="footnote-item"><p>注意开头的字母是小写的L，同样是大佬所言，博主注 <a href="#fnref1" class="footnote-backref">↩︎</a></p>
</li>
<li id="fn2" class="footnote-item"><p>谢希仁，《计算机网络(第8版)》，以下简称《计网》，P8 <a href="#fnref2" class="footnote-backref">↩︎</a></p>
</li>
<li id="fn3" class="footnote-item"><p>RFC 959， STD9 <a href="#fnref3" class="footnote-backref">↩︎</a></p>
</li>
<li id="fn4" class="footnote-item"><p>RFC 7540 <a href="#fnref4" class="footnote-backref">↩︎</a></p>
</li>
<li id="fn5" class="footnote-item"><p>前端代码来自 <span class="exturl"><a class="exturl__link"   target="_blank" rel="noopener" href="https://blog.csdn.net/u012324798/article/details/103549249" >https://blog.csdn.net/u012324798/article/details/103549249</a><span class="exturl__icon"><i class="fas fa-external-link-alt"></i></span></span> ，有修改 <a href="#fnref5" class="footnote-backref">↩︎</a></p>
</li>
<li id="fn6" class="footnote-item"><p>《计网》 P220 <a href="#fnref6" class="footnote-backref">↩︎</a></p>
</li>
<li id="fn7" class="footnote-item"><p><span class="exturl"><a class="exturl__link"   target="_blank" rel="noopener" href="https://docs.python.org/zh-cn/3/library/struct.html" >https://docs.python.org/zh-cn/3/library/struct.html</a><span class="exturl__icon"><i class="fas fa-external-link-alt"></i></span></span> <a href="#fnref7" class="footnote-backref">↩︎</a></p>
</li>
</ol>
</section>
</div><footer class="post-footer"><div class="post-ending ending"><div class="ending__text">------ 本文结束，感谢您的阅读 ------</div></div><div class="post-tags"><span class="post-tags-item"><span class="post-tags-item__icon"><i class="fas fa-tag"></i></span><a class="post-tags-item__link" href="https://blog.2333332.xyz/tags/python/">python</a></span><span class="post-tags-item"><span class="post-tags-item__icon"><i class="fas fa-tag"></i></span><a class="post-tags-item__link" href="https://blog.2333332.xyz/tags/javascript/">javascript</a></span><span class="post-tags-item"><span class="post-tags-item__icon"><i class="fas fa-tag"></i></span><a class="post-tags-item__link" href="https://blog.2333332.xyz/tags/websocket/">websocket</a></span><span class="post-tags-item"><span class="post-tags-item__icon"><i class="fas fa-tag"></i></span><a class="post-tags-item__link" href="https://blog.2333332.xyz/tags/%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C/">计算机网络</a></span></div><nav class="post-paginator paginator"><div class="paginator-prev"><a class="paginator-prev__link" href="/2022/09/20/2022-09-20-mid-in-2022/"><span class="paginator-prev__icon"><i class="fas fa-angle-left"></i></span><span class="paginator-prev__text">22年秋</span></a></div><div class="paginator-next"><a class="paginator-next__link" href="/2022/03/15/2022-03-15-review-2022/"><span class="paginator-prev__text">2021年终总结</span><span class="paginator-next__icon"><i class="fas fa-angle-right"></i></span></a></div></nav></footer></div></div><div class="comments" id="comments"><div id="waline-container"></div></div></div><div class="sidebar-wrap" id="sidebar-wrap"><aside class="sidebar" id="sidebar"><div class="sidebar-nav"><span class="sidebar-nav-toc current">文章目录</span><span class="sidebar-nav-ov">站点概览</span></div><section class="sidebar-toc"><ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%BA%8F-3"><span class="toc-number">1.</span> <span class="toc-text">
          序</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%8F%A1%E6%89%8B"><span class="toc-number">2.</span> <span class="toc-text">
          握手</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%AE%A2%E6%88%B7%E7%AB%AF"><span class="toc-number">2.1.</span> <span class="toc-text">
          客户端</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%9C%8D%E5%8A%A1%E5%99%A8%E7%AB%AF"><span class="toc-number">2.2.</span> <span class="toc-text">
          服务器端</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%95%B0%E6%8D%AE%E5%B8%A7"><span class="toc-number">3.</span> <span class="toc-text">
          数据帧</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%AF%BB%E5%B8%A7"><span class="toc-number">3.1.</span> <span class="toc-text">
          读帧</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%86%99%E5%B8%A7"><span class="toc-number">3.2.</span> <span class="toc-text">
          写帧</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%A4%84%E7%90%86%E6%8E%A7%E5%88%B6%E5%B8%A7"><span class="toc-number">3.3.</span> <span class="toc-text">
          处理控制帧</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%85%B3%E9%97%AD"><span class="toc-number">3.3.1.</span> <span class="toc-text">
          关闭</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E4%B9%92%E4%B9%93"><span class="toc-number">3.3.2.</span> <span class="toc-text">
          乒乓</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%80%BB%E7%9A%84%E4%BB%A3%E7%A0%81"><span class="toc-number">4.</span> <span class="toc-text">
          总的代码</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%90%8E%E7%AB%AF"><span class="toc-number">4.1.</span> <span class="toc-text">
          后端</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%89%8D%E7%AB%AF"><span class="toc-number">4.2.</span> <span class="toc-text">
          前端</span></a></li></ol></li></ol></section><!-- ov = overview--><section class="sidebar-ov hide"><div class="sidebar-ov-author"><div class="sidebar-ov-author__avatar"><img class="sidebar-ov-author__avatar_img" src="https://xjc.cn-sh2.ufileos.com/assets/site/icon.png" alt="avatar"></div><p class="sidebar-ov-author__text">Be yourself.</p></div><div class="sidebar-ov-social"><a class="sidebar-ov-social-item" href="https://github.com/xizeyoupan" target="_blank" rel="noopener" data-popover="Github" data-popover-pos="up"><span class="sidebar-ov-social-item__icon"><i class="fab fa-github"></i></span></a><a class="sidebar-ov-social-item" href="https://steamcommunity.com/profiles/76561198427207841" target="_blank" rel="noopener" data-popover="Steam" data-popover-pos="up"><span class="sidebar-ov-social-item__icon"><i class="fab fa-steam"></i></span></a></div><div class="sidebar-ov-feed"><span class="sidebar-ov-feed-rss"><a class="sidebar-ov-feed-rss__link" href="/atom.xml" target="_blank" rel="noopener"><span class="sidebar-ov-feed-rss__icon"><i class="fas fa-rss"></i></span><span>RSS 订阅</span></a></span></div><div class="sidebar-ov-state"><a class="sidebar-ov-state-item sidebar-ov-state-item--posts" href="/archives/"><div class="sidebar-ov-state-item__count">16</div><div class="sidebar-ov-state-item__name">归档</div></a><a class="sidebar-ov-state-item sidebar-ov-state-item--categories" href="/categories/"><div class="sidebar-ov-state-item__count">2</div><div class="sidebar-ov-state-item__name">分类</div></a><a class="sidebar-ov-state-item sidebar-ov-state-item--tags" href="/tags/"><div class="sidebar-ov-state-item__count">39</div><div class="sidebar-ov-state-item__name">标签</div></a></div><div class="sidebar-ov-cc"><a href="https://creativecommons.org/licenses/by-nc-sa/4.0/deed.en" target="_blank" rel="noopener" data-popover="知识共享许可协议" data-popover-pos="up"><img src="/images/cc-by-nc-sa.svg"></a></div></section><div class="sidebar-reading"><div class="sidebar-reading-info"><span class="sidebar-reading-info__text">你已阅读了 </span><span class="sidebar-reading-info__num">0</span><span class="sidebar-reading-info__perc">%</span></div><div class="sidebar-reading-line"></div></div></aside></div><div class="clearfix"></div></div></main><footer class="footer" id="footer"><div class="footer-inner"><div><span>Copyright © 2023</span><span class="footer__icon"><i class="fas fa-heart"></i></span><span>Krypton</span></div><div><span>由 <a href="http://hexo.io/" title="Hexo" target="_blank" rel="noopener">Hexo</a> 强力驱动</span><span> v6.0.0</span><span class="footer__devider">|</span><span>主题 - <a href="https://github.com/liuyib/hexo-theme-stun/" title="Stun" target="_blank" rel="noopener">Stun</a></span><span> v2.8.0</span></div><script>var meting_api= 'https://meting-ve.2333332.xyz/api?server=:server&type=:type&id=:id&auth=:auth&r=:r'
</script><style>.aplayer {
    color: initial;
    text-align: initial;
}
</style><link rel="stylesheet" href="https://unpkg.2333332.xyz/aplayer/dist/APlayer.min.css"><script src="https://unpkg.2333332.xyz/aplayer/dist/APlayer.min.js"></script><script src="https://unpkg.2333332.xyz/@xizeyoupan/meting@latest/dist/Meting.min.js"></script><meting-js server="ytmusic" type="playlist" id="PLEqSd0CstNysjgFMnQCXoaJg9MtroKfGg" fixed="true" order="random"></meting-js></div></footer><div class="loading-bar" id="loading-bar"><div class="loading-bar__progress"></div></div><div class="back2top" id="back2top"><span class="back2top__icon"><i class="fas fa-rocket"></i></span></div></div><div class="search-mask"></div><div class="search-popup"><span class="search-close"></span><div class="search-input"><input placeholder="搜索文章（支持多关键词，请用空格分隔）"></div><div class="search-results"></div></div><script src="https://unpkg.2333332.xyz/jquery@v3.4.1/dist/jquery.min.js"></script><script src="https://unpkg.2333332.xyz/velocity-animate@1.5.2/velocity.min.js"></script><script src="https://unpkg.2333332.xyz/velocity-animate@1.5.2/velocity.ui.min.js"></script><script src="https://unpkg.2333332.xyz/lazyload@2.0.0-rc.2/lazyload.min.js"></script><script>function initSearch() {
  var isXML = true;
  var search_path = 'search.json';

  if (!search_path) {
    search_path = 'search.xml';
  } else if (/json$/i.test(search_path)) {
    isXML = false;
  }

  var path = '/' + search_path;
  $.ajax({
    url: path,
    dataType: isXML ? 'xml' : 'json',
    async: true,
    success: function (res) {
      var datas = isXML ? $('entry', res).map(function () {
        // 将 XML 转为 JSON
        return {
          title: $('title', this).text(),
          content: $('content', this).text(),
          url: $('url', this).text()
        };
      }).get() : res;
      var $input = $('.search-input input');
      var $result = $('.search-results');
      // 搜索对象（标题、内容）的权重，影响显示顺序
      var WEIGHT = { title: 100, content: 1 };
      var searchPost = function () {
        var searchText = $input.val().toLowerCase().trim();
        // 根据空白字符分隔关键字
        var keywords = searchText.split(/[\s]+/);
        // 搜索结果
        var matchPosts = [];

        // 有多个关键字时，将原文字整个保存下来
        if (keywords.length > 1) {
          keywords.push(searchText);
        }
        // 防止未输入字符时搜索
        if (searchText.length > 0) {
          datas.forEach(function (data) {
            var isMatch  = false;
            // 没有标题的文章使用预设的 i18n 变量代替
            var title = (data.title && data.title.trim()) || '[ 文章无标题 ]';
            var titleLower = title && title.toLowerCase();
            // 删除 HTML 标签 和 所有空白字符
            var content = data.content && data.content.replace(/<[^>]+>/g, '');
            var contentLower = content && content.toLowerCase();
            // 删除重复的 /
            var postURL = data.url && decodeURI(data.url).replace(/\/{2,}/g, '/');
            // 标题中匹配到的关键词
            var titleHitSlice = [];
            // 内容中匹配到的关键词
            var contentHitSlice = [];

            keywords.forEach(function (keyword) {
              /**
              * 获取匹配的关键词的索引
              * @param {String} keyword 要匹配的关键字
              * @param {String} text 原文字
              * @param {Boolean} caseSensitive 是否区分大小写
              * @param {Number} weight 匹配对象的权重。权重大的优先显示
              * @return {Array}
              */
              function getIndexByword (word, text, caseSensitive, weight) {
                if (!word || !text) {
                  return [];
                };

                var startIndex = 0; // 每次匹配的开始索引
                var index = -1;     // 匹配到的索引值
                var result = [];    // 匹配结果

                if (!caseSensitive) {
                  word = word.toLowerCase();
                  text = text.toLowerCase();
                }

                while((index = text.indexOf(word, startIndex)) !== -1) {
                  var hasMatch = false;
                  // 索引位置相同的关键词，保留长度较长的
                  titleHitSlice.forEach(function (hit) {
                    if (hit.index === index && hit.word.length < word.length) {
                      hit.word = word;
                      hasMatch = true;
                    }
                  });
                  startIndex = index + word.length;
                  !hasMatch && result.push({ index: index, word: word, weight: weight });
                }
                return result;
              }
              titleHitSlice = titleHitSlice.concat(getIndexByword(keyword, titleLower, false, WEIGHT.title));
              contentHitSlice = contentHitSlice.concat(getIndexByword(keyword, contentLower, false, WEIGHT.content));
            });

            var hitTitle = titleHitSlice.length;
            var hitContent = contentHitSlice.length;

            if (hitTitle > 0 || hitContent > 0) {
              isMatch = true;
            }
            if (isMatch) {
              ;[titleHitSlice, contentHitSlice].forEach(function (hit) {
                // 按照匹配文字的索引的递增顺序排序
                hit.sort(function (left, right) {
                  return left.index - right.index;
                });
              });
              /**
              * 给文本中匹配到的关键词添加标记，从而进行高亮显示
              * @param {String} text 原文本
              * @param {Array} hitSlice 匹配项的索引信息
              * @param {Number} start 开始索引
              * @param {Number} end 结束索引
              * @return {String}
              */
              function highlightKeyword (text, hitSlice, start, end) {
                if (!text || !hitSlice || !hitSlice.length) {
                  return;
                }

                var result = '';
                var startIndex = start;
                var endIndex = end;
                hitSlice.forEach(function (hit) {
                  if (hit.index < startIndex) {
                    return;
                  }

                  var hitWordEnd = hit.index + hit.word.length;
                  result += text.slice(startIndex, hit.index);
                  result += '<b>' + text.slice(hit.index, hitWordEnd) + '</b>';
                  startIndex = hitWordEnd;
                });
                result += text.slice(startIndex, endIndex);
                return result;
              }

              var postData = {};
              // 文章总的搜索权重
              var postWeight = titleHitSlice.length * WEIGHT.title + contentHitSlice.length * WEIGHT.content;
              // 标记匹配关键词后的标题
              var postTitle = highlightKeyword(title, titleHitSlice, 0, title.length) || title;
              // 标记匹配关键词后的内容
              var postContent;
              // 显示内容的长度
              var SHOW_WORD_LENGTH = 200;
              // 命中关键词前的字符显示长度
              var SHOW_WORD_FRONT_LENGTH = 20;
              var SHOW_WORD_END_LENGTH = SHOW_WORD_LENGTH - SHOW_WORD_FRONT_LENGTH;

              // 截取匹配的第一个字符，前后共 200 个字符来显示
              if (contentHitSlice.length > 0) {
                var firstIndex = contentHitSlice[0].index;
                var start = firstIndex > SHOW_WORD_FRONT_LENGTH ? firstIndex - SHOW_WORD_FRONT_LENGTH : 0;
                var end = firstIndex + SHOW_WORD_END_LENGTH;
                postContent = highlightKeyword(content, contentHitSlice, start, end);
              } else { // 未匹配到内容，直接截取前 200 个字符来显示
                postContent = content.slice(0, SHOW_WORD_LENGTH);
              }
              postData.title = postTitle;
              postData.content = postContent;
              postData.url = postURL;
              postData.weight = postWeight;
              matchPosts.push(postData);
            }
          });
        }

        var resultInnerHtml = '';
        if (matchPosts.length) {
          // 按权重递增的顺序排序，使权重大的优先显示
          matchPosts.sort(function (left, right) {
            return right.weight - left.weight;
          });
          resultInnerHtml += '<ul>';
          matchPosts.forEach(function (post) {
            resultInnerHtml += '<li><a class="search-results-title" href="' + post.url + '">';
            resultInnerHtml += post.title;
            resultInnerHtml += '</a><div class="search-results-content">';
            resultInnerHtml += post.content;
            resultInnerHtml += '</div></li>';
          });
          resultInnerHtml += '</ul>';
        } else {
          resultInnerHtml += '<div class="search-results-none"><i class="far fa-meh"></i></div>';
        }
        $result.html(resultInnerHtml);
      };
      $input.on('input', searchPost);
      $input.on('keyup', function (e) {
        if (e.keyCode === Stun.utils.codeToKeyCode('Enter')) {
          searchPost();
        }
      });
    }
  });
}

function closeSearch () {
  $('body').css({ overflow: 'auto' });
  $('.search-popup').css({ display: 'none' });
  $('.search-mask').css({ display: 'none' });
}

window.addEventListener('DOMContentLoaded', function () {
  Stun.utils.pjaxReloadLocalSearch = function () {
    $('.header-nav-search').on('click', function (e) {
      e.stopPropagation();
      $('body').css('overflow', 'hidden');
      $('.search-popup')
        .velocity('stop')
        .velocity('transition.expandIn', {
          duration: 300,
          complete: function () {
            $('.search-popup input').focus();
          }
        });
      $('.search-mask')
        .velocity('stop')
        .velocity('transition.fadeIn', {
          duration: 300
        });

      initSearch();
    });
    $('.search-mask, .search-close').on('click', function () {
      closeSearch();
    });
    $(document).on('keydown', function (e) {
      // Escape <=> 27
      if (e.keyCode === Stun.utils.codeToKeyCode('Escape')) {
        closeSearch();
      }
    });
  };

  Stun.utils.pjaxReloadLocalSearch();
}, false);

function safeOpenUrl(url) {
  var newTab = window.open();
  newTab.opener = null;
  newTab.location = url;
}

function extSearch(engine) {
  var engines = {
    google: 'https://www.google.com/search?q=',
    bing: 'https://cn.bing.com/search?q=',
    baidu: 'https://www.baidu.com/s?ie=UTF-8&wd=',
  };
  var host = window.location.host;
  var query = $('.search-input input').val().toLowerCase().trim();
  var uri = engines[engine] + query + ' site:' + host;

  if (query) {
    safeOpenUrl(uri);
  } else {
    Stun.utils.popAlert('warning', '请输入字符');
  }
}

var assistSearchList = window.CONFIG.assistSearch;

if (Array.isArray(assistSearchList)) {
  assistSearchList.forEach(function (name) {
    document.querySelector('.search-btns-item--' + name).addEventListener('click', function () {
      extSearch(name);
    }, false);
  });
}</script><script src="https://unpkg.2333332.xyz/pjax@latest/pjax.min.js"></script><script>window.addEventListener('DOMContentLoaded', function () {
  var pjax = new Pjax({"selectors":["head title","#main",".pjax-reload",".header-inner"],"history":true,"scrollTo":false,"scrollRestoration":false,"cacheBust":false,"debug":false,"currentUrlFullReload":false,"timeout":0});
  // 加载进度条的计时器
  var loadingTimer = null;

  // 重置页面 Y 方向上的滚动偏移量
  document.addEventListener('pjax:send', function () {
    $('.header-nav-menu').removeClass('show');
    if (CONFIG.pjax && CONFIG.pjax.avoidBanner) {
      $('html').velocity('scroll', {
        duration: 500,
        offset: $('#header').height(),
        easing: 'easeInOutCubic'
      });
    }

    var loadingBarWidth = 20;
    var MAX_LOADING_WIDTH = 95;

    $('.loading-bar').addClass('loading');
    $('.loading-bar__progress').css('width', loadingBarWidth + '%');
    clearInterval(loadingTimer);
    loadingTimer = setInterval(function () {
      loadingBarWidth += 3;
      if (loadingBarWidth > MAX_LOADING_WIDTH) {
        loadingBarWidth = MAX_LOADING_WIDTH;
      }
      $('.loading-bar__progress').css('width', loadingBarWidth + '%');
    }, 500);
  }, false);

  window.addEventListener('pjax:complete', function () {
    clearInterval(loadingTimer);
    $('.loading-bar__progress').css('width', '100%');
    $('.loading-bar').removeClass('loading');
    setTimeout(function () {
      $('.loading-bar__progress').css('width', '0');
    }, 400);
    $('link[rel=prefetch], script[data-pjax-rm]').each(function () {
      $(this).remove();
    });
    $('script[data-pjax], #pjax-reload script').each(function () {
      $(this).parent().append($(this).remove());
    });

    if (Stun.utils.pjaxReloadBoot) {
      Stun.utils.pjaxReloadBoot();
    }
    if (Stun.utils.pjaxReloadScroll) {
      Stun.utils.pjaxReloadScroll();
    }
    if (Stun.utils.pjaxReloadSidebar) {
      Stun.utils.pjaxReloadSidebar();
    }
    if (true) {
      if (Stun.utils.pjaxReloadHeader) {
        Stun.utils.pjaxReloadHeader();
      }
      if (Stun.utils.pjaxReloadScrollIcon) {
        Stun.utils.pjaxReloadScrollIcon();
      }
      if (Stun.utils.pjaxReloadLocalSearch) {
        Stun.utils.pjaxReloadLocalSearch();
      }
    }
  }, false);
}, false);</script><div id="pjax-reload"></div><link rel="stylesheet" href="https://unpkg.2333332.xyz/@waline/client@v2/dist/waline.css"><script type="module" data-pjax="">import { init } from 'https://unpkg.2333332.xyz/@waline/client@v2/dist/waline.mjs';
import { pageviewCount } from 'https://unpkg.com/@waline/client@v2/dist/pageview.mjs';

function loadWaline () {
  var GUEST_INFO = ['nick', 'mail', 'link'];
  var guest_info = 'nick,mail,link';

  guest_info = guest_info.split(',').filter(function(item) {
    return GUEST_INFO.indexOf(item) > -1;
  });

  pageviewCount({
    serverURL: 'https://waline.2333332.xyz',
    path: window.location.pathname,

    // optional, for custom selectors, defaults to `'.waline-pageview-count'`
    // selector: 'waline-pageview-count',

    // optional, whether to increase the number of visits when fetching, the default is `true`
    // update: true,
  });

  if(!document.getElementById('waline-container')) return

  init({
    el: '#waline-container',
    serverURL: 'https://waline.2333332.xyz',
    pageSize: '10' || 10,
    lang: '' || 'zh-CN',
    pageview: location.hostname!=='localhost' && true,
    path: window.location.pathname,
    meta: guest_info,
    emoji: [
      '//unpkg.2333332.xyz/@waline/emojis@1.1.0/weibo',
      '//unpkg.2333332.xyz/@waline/emojis@1.1.0/bilibili',
      '//unpkg.2333332.xyz/@waline/emojis@1.1.0/alus',
      '//unpkg.2333332.xyz/@waline/emojis@1.1.0/bmoji',
      '//unpkg.2333332.xyz/@waline/emojis@1.1.0/qq',
      '//unpkg.2333332.xyz/@waline/emojis@1.1.0/tieba'
    ],
    reaction: true,
    locale: { placeholder: 'Just go go (*/ω＼*)\n邮箱不会公开，你可以不填邮箱，或随便填一个邮箱，或写一个别人的邮箱（大雾' },
  });
}

if (true) {
  loadWaline();
} else {
  window.addEventListener('DOMContentLoaded', loadWaline, false);
}</script><script src="/js/utils.js?v=2.8.0"></script><script src="/js/stun-boot.js?v=2.8.0"></script><script src="/js/scroll.js?v=2.8.0"></script><script src="/js/header.js?v=2.8.0"></script><script src="/js/sidebar.js?v=2.8.0"></script><script type="application/json" src="/search.json"></script><script src="https://unpkg.com/live2d-widget@^3.1.3/lib/L2Dwidget.min.js"></script><script>L2Dwidget.init({"pluginRootPath":"live2dw/","pluginJsPath":"lib/","pluginModelPath":"assets/","tagMode":false,"debug":true,"model":{"jsonPath":"https://unpkg.2333332.xyz/live2d-widget-model-mashiro-seifuku@1.0.1/assets/seifuku.model.json"},"display":{"position":"right","width":240,"height":480,"hOffset":0,"vOffset":0},"mobile":{"show":false},"react":{"opacity":0.8},"log":false});</script></body></html>